doctype html
head
    title Pusher Test
    script(src='//js.pusher.com/2.2/pusher.min.js', type='text/javascript')
    script(src='/components/jquery/dist/jquery.min.js', type='text/javascript')
    script(src='/components/semantic-ui/dist/semantic.min.js', type='text/javascript')
    link(rel='stylesheet', type='text/css', href='/components/semantic-ui/dist/semantic.min.css')
    script(type='text/javascript').
      // Enable pusher logging - don't include this in production
      Pusher.log = function(message) {
        if (window.console && window.console.log) {
          window.console.log(message);
        }
      };
      var pusherPublic = "#{config.pusherPublic}";
      var pusher = new Pusher(pusherPublic);
      var channel = pusher.subscribe('feed');
      channel.bind('message', function(data) {
        var doc = $('#feed');
        var el = $('#' + data._id);
        var exists = el.length === 1;

        if(exists) {
          var counter = el.find('.counter');
          var value = counter.html();
          value = parseInt(value);
          value++;
          console.log('vakl', value);
          counter.html(String(value++));
        } else {
          if(data.parsedType === 'image') doc.prepend('<p> <img src="' + data.parsedResult + '" /> </p>');
          else doc.prepend('<p> <a href="' + data.parsedResult + '"> ' + data.parsedResult + ' </a> </p>' );
        }
      });

  body
    .ui.one.column.stackable.center.aligned.page.grid
      .column.twelve.wide
        - if(loggedIn) {
          h1 Hello #{user.name}
        - } else {
          .ui.huge.buttons.float.centered
            .ui.button
              a(href='/auth/slack') Signup with Slack
        - }

    .ui.page.centered.grid
      .twelve.wide.column.ui.feed
          .ui.clearing.divider
          .h1.ui.header Feed
          - for record in records
            .event
              .label
                  img(src='http://placehold.it/290x290')
              .content
                - var date = new Date(record.created_at);
                - var d = date.getDate();
                - var m = date.getMonth();
                - var y = date.getYear();
                .date #{d}.#{m}.#{y}
                .summary
                  a.user
                  | #{record.user} added a #{record.parsedType} in #{record.channel}
                - if(record.parsedType === 'image') {
                  .extra.images
                    a
                      img(src=record.parsedResult)
                - } else {
                  .extra.text
                    a.link(href=record.parsedResult) #{record.parsedResult}
                - }
                .meta
                  a.like
                    i.like.icon
                    | #{record.counter} shares